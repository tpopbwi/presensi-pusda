<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>E-PRESENSI PUSDA PRO</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-gradient: radial-gradient(circle at top right, #3b82f6, #1e3a8a);
            --primary-blue: #1e3a8a;
            --accent-blue: #60a5fa;
            --accent-orange: #f97316;
            --white: #ffffff;
            --glass: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --success: #10b981;
            --danger: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg-gradient); 
            background-attachment: fixed; 
            color: #f8fafc; 
            min-height: 100vh; 
            overflow-x: hidden;
        }

        .bg-watermark {
            position: fixed; 
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 0; 
            pointer-events: none; 
            opacity: 0.12; 
            width: 70vw;
            max-width: 350px;
            display: flex; justify-content: center; align-items: center;
        }
        .bg-watermark img {
            width: 100%; height: auto;
            filter: grayscale(100%) contrast(1.2); 
        }

        #loadingOverlay { 
            position: fixed; inset: 0; z-index: 2000; 
            background: var(--bg-gradient); 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.8s ease; 
        }

        #statusToast { 
            position: fixed; inset: 0; z-index: 3000; display: none;
            flex-direction: column; align-items: center; justify-content: center; 
            background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(15px); 
        }
        .toast-content {
            background: rgba(255, 255, 255, 0.1); border: 1px solid var(--glass-border);
            padding: 40px; border-radius: 40px; text-align: center;
            box-shadow: 0 30px 60px rgba(0,0,0,0.5);
        }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .app-container { 
            width: 100%; max-width: 500px; margin: 0 auto; 
            min-height: 100vh; position: relative; z-index: 1;
            padding-top: 0; 
            display: flex; flex-direction: column;
        }

        .header-overlay {
            position: absolute; 
            top: 0; left: 0; right: 0; 
            padding: 20px;
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            z-index: 50; 
            background: linear-gradient(to bottom, rgba(0,0,0,0.4), transparent); 
        }

        .hero-section { 
            position: relative; 
            width: 100%; 
            height: 45vh; 
            display: flex; 
            align-items: flex-end; 
            justify-content: center; 
            margin-top: 80px; 
            margin-bottom: 0px;
            overflow: visible;
            z-index: 1;
        }
        
        .hero-section img { 
            height: 110%; 
            object-fit: contain; 
            z-index: 1; 
            filter: drop-shadow(0 35px 50px rgba(0,0,0,0.8)); 
            transform: scale(1.15); 
        }

        .main-card { 
            background: linear-gradient(to bottom, rgba(15, 23, 42, 0.8) 0%, rgba(15, 23, 42, 0.98) 100%); 
            backdrop-filter: blur(25px); border-radius: 40px 40px 0 0; 
            margin-top: -40px; 
            padding: 40px 25px 40px; 
            position: relative;
            z-index: 20; 
            border-top: 1px solid var(--glass-border); 
            flex: 1;
        }

        .slider-controls { display: flex; justify-content: center; align-items: center; margin-bottom: 30px; position: relative; }
        .nav-circle { 
            width: 50px; height: 50px; background: var(--glass); 
            border: 1px solid var(--glass-border); border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            color: white; cursor: pointer; position: absolute; top: 50%; transform: translateY(-50%);
        }
        .btn-prev { left: 0; }
        .btn-next { right: 0; }

        .filter-container { 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 10px; 
            padding-bottom: 15px; 
        }
        .chip { padding: 10px 18px; background: var(--glass); border-radius: 16px; font-weight: 800; font-size: 0.8rem; color: rgba(255,255,255,0.6); white-space: nowrap; border: 1px solid transparent; }
        .chip.active { background: var(--accent-orange); color: white; box-shadow: 0 5px 15px rgba(249, 115, 22, 0.4); }

        .app-footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            opacity: 0.6;
            text-align: center;
        }
        .app-footer img {
            height: 35px;
            width: auto;
            filter: grayscale(100%) brightness(200%); 
        }
        .social-icons {
            display: flex;
            gap: 20px;
            margin-top: 5px;
        }
        .social-icons i {
            width: 20px;
            height: 20px;
            cursor: pointer;
            transition: 0.2s;
        }
        .social-icons i:hover {
            color: var(--accent-orange);
            transform: scale(1.2);
        }

        #presenceView { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: var(--bg-gradient); 
            z-index: 1000; 
            overflow-y: auto; 
            padding: 0;
        }
        
        .presence-card {
            width: 100%;
            max-width: 500px; 
            margin: 0 auto;
            min-height: 100vh;
            background: linear-gradient(to bottom, rgba(15, 23, 42, 0.95) 0%, rgba(15, 23, 42, 1) 100%);
            backdrop-filter: blur(30px);
            padding: 30px 25px 50px;
            border-top: 1px solid var(--glass-border);
        }

        .step-box { margin-bottom: 25px; opacity: 0.5; transition: 0.3s; pointer-events: none; }
        .step-box.is-valid, .step-box:first-of-type, .step-box.active-step { opacity: 1; pointer-events: auto; }
        
        .step-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size:0.75rem; font-weight:800; opacity:0.9; letter-spacing: 0.5px; }
        .step-icon { transition: 0.3s; color: rgba(255,255,255,0.3); }
        .step-box.is-valid .step-icon { color: var(--success); transform: scale(1.1); }

        .status-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
        .status-box { 
            padding: 15px; border-radius: 18px; background: var(--glass); 
            border: 1px solid var(--glass-border); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;
            font-weight: 800; font-size: 0.75rem; transition: 0.2s; cursor: pointer;
        }
        .status-box svg { opacity: 0.7; transition: 0.2s; }
        .status-box.active { background: white; color: var(--primary-blue); transform: scale(0.98); }
        .status-box.active svg { opacity: 1; }
        .status-box.active.hadir { background: #10b981; color: white; box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3); border-color: transparent; }
        .status-box.active.pulang { background: #3b82f6; color: white; box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3); border-color: transparent; }
        #late-alert {
            display: none;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid var(--danger);
            color: #fca5a5;
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            font-weight: 800;
            font-size: 0.85rem;
            margin-top: 15px;
            animation: fadeIn 0.3s ease;
            line-height: 1.5;
        }
        #late-alert i { vertical-align: bottom; margin-right: 5px; }
        .camera-item {
            width: 100%; border: 2px dashed var(--glass-border); border-radius: 20px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; overflow: hidden; cursor: pointer;
            background: rgba(255,255,255,0.03); transition: 0.3s;
        }
        #box-selfie { aspect-ratio: 3 / 4; }
        #box-work { aspect-ratio: 4 / 3; } 

        .camera-item.has-photo { border-style: solid; border-color: #10b981; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .camera-item img { width: 100%; height: 100%; object-fit: cover; position: absolute; display: none; }

        .info-bar { display: flex; justify-content: space-between; background: rgba(255,255,255,0.05); padding: 12px 20px; border-radius: 15px; margin-bottom: 20px; font-size: 0.75rem; font-weight: 800; border: 1px solid var(--glass-border); }
        input[type="text"], textarea { width: 100%; background: rgba(255,255,255,0.06); border: 1px solid var(--glass-border); color: white; border-radius: 15px; padding: 15px; outline: none; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="bg-watermark">
        <img src="https://lh3.googleusercontent.com/d/1T2CMdDlMOVBTHr-hy1uBjZhxnKJPrd2m" alt="Logo Watermark">
    </div>
    <div id="loadingOverlay">
        <img src="https://lh3.googleusercontent.com/d/1T2CMdDlMOVBTHr-hy1uBjZhxnKJPrd2m" style="width: 100px; height: auto; margin-bottom: 20px;" alt="Logo Loading">
        <div class="spin"><i data-lucide="loader-2" size="40" color="white"></i></div>
        <p style="margin-top:15px; letter-spacing:3px; font-weight: 800; font-size: 0.8rem;">MEMUAT SISTEM</p>
    </div>

    <div id="statusToast">
        <div class="toast-content">
            <div id="toastIcon"></div>
            <p id="toastMessage" style="font-weight:800; font-size: 1.1rem; margin-top: 15px;"></p>
        </div>
    </div>

    <div class="app-container">
        <div class="header-overlay">
            <div style="display: flex; align-items: center; gap: 10px;">
                <img src="https://lh3.googleusercontent.com/d/1T2CMdDlMOVBTHr-hy1uBjZhxnKJPrd2m" style="height: 45px; width: auto; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.3));">
                <div>
                    <h1 style="font-size: 1rem; font-weight: 900; line-height: 1;">E-PRESENSI</h1>
                    <p style="font-size: 0.7rem; opacity: 0.8;">UPT PSDA WS BONDOYUDO</p>
                </div>
            </div>
            <div style="text-align: right; text-shadow: 0 2px 10px rgba(0,0,0,0.5);">
                <div id="mainClock" style="font-size: 1.3rem; font-weight: 900; line-height:1;">00:00</div>
                <div id="mainDate" style="font-size: 0.7rem; font-weight: 700; opacity: 0.9; text-transform: uppercase;">...</div>
            </div>
        </div>
        <div id="mainView">
            <section class="hero-section">
                <div id="slidePhoto" style="width:100%; height:100%; display:flex; align-items:flex-end; justify-content:center;"></div>
            </section>

            <section class="main-card">
                <div class="info-bar">
                    <span style="color: #10b981;">MASUK: <span id="infoJamHadir">--:--</span></span>
                    <span style="color: #60a5fa;">PULANG: <span id="infoJamPulang">--:--</span></span>
                </div>
                
                <div class="slider-controls">
                    <button class="nav-circle btn-prev" onclick="prevMember()"><i data-lucide="chevron-left"></i></button>
                    <div style="text-align:center; padding: 0 60px;">
                        <h2 id="dispName" style="font-size:1.6rem; font-weight:900; line-height:1.1;">Memuat...</h2>
                        <p id="dispRole" style="font-size:0.8rem; color:var(--accent-blue); font-weight: 800; margin-top:5px;">...</p>
                    </div>
                    <button class="nav-circle btn-next" onclick="nextMember()"><i data-lucide="chevron-right"></i></button>
                </div>

                <input type="text" id="nameSearch" placeholder="Cari Pegawai..." oninput="handleSearch()" style="margin-bottom: 15px;">
                <div class="filter-container" id="wilayahFilter">
                    <div class="chip active" onclick="setRegion('ALL', this)">ALL</div>
                    <div class="chip" onclick="setRegion('BANGOREJO', this)">BANGOREJO</div>
                    <div class="chip" onclick="setRegion('CLURING', this)">CLURING</div>
                    <div class="chip" onclick="setRegion('PESANGGARAN', this)">PESANGGARAN</div>
                    <div class="chip" onclick="setRegion('POROLINGGO', this)">POROLINGGO</div>
                </div>

                <button onclick="openPresence()" style="width:100%; padding:20px; border-radius:20px; border:none; background:white; color:var(--primary-blue); font-weight:900; font-size:1.1rem; margin-top:15px; display:flex; align-items:center; justify-content:center; gap:10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); cursor:pointer;">
                    <i data-lucide="scan-face" size="24"></i> MULAI PRESENSI
                </button>
                <div class="app-footer">
                    <img src="https://lh3.googleusercontent.com/d/1T2CMdDlMOVBTHr-hy1uBjZhxnKJPrd2m" alt="Logo Footer">
                    <div>
                        <div style="font-weight: 800; font-size: 0.75rem; letter-spacing: 1px;">UPT PSDA WS BONDOYUDO</div>
                        <div style="font-size: 0.65rem;">Sistem Presensi Pegawai Digital v2.5</div>
                    </div>
                    <!-- Social Icons -->
                    <div class="social-icons">
                        <i data-lucide="globe" onclick="window.open('https://sda.jatimprov.go.id/', '_blank')"></i>
                        <i data-lucide="instagram" onclick="window.open('#', '_blank')"></i>
                        <i data-lucide="facebook" onclick="window.open('#', '_blank')"></i>
                    </div>
                </div>
            </section>
        </div>
    </div>
    <div id="presenceView">
        <div class="presence-card">
            <div onclick="closePresence()" style="display:flex; align-items:center; gap:10px; font-weight:800; margin-bottom:25px; cursor:pointer; color: var(--accent-blue);">
                <i data-lucide="arrow-left"></i> KEMBALI
            </div>
            <div style="display:flex; gap:20px; margin-bottom:30px; align-items:center;">
                <img id="presImg" src="" style="width:90px; aspect-ratio:3/4; border-radius:15px; object-fit:cover; border:2px solid white; box-shadow: 0 10px 25px rgba(0,0,0,0.3);">
                <div>
                    <h3 id="presName" style="font-weight:900; font-size:1.3rem; line-height: 1.2;">Nama</h3>
                    <p id="presRole" style="font-size:0.85rem; color:var(--accent-blue); margin-top: 5px;">Jabatan</p>
                    <div style="display:flex; align-items:center; gap:5px; margin-top:5px; font-size:0.7rem; color:var(--success);">
                        <i data-lucide="badge-check" size="14"></i> <span>Terverifikasi</span>
                    </div>
                </div>
            </div>
            <div id="step-gps" class="step-box active-step">
                <div class="step-header">
                    <span>LOKASI GPS (BEBAS)</span>
                    <i data-lucide="circle" class="step-icon" id="icon-gps"></i>
                </div>
                <div style="padding:15px; background:rgba(255,255,255,0.05); border-radius:15px; display:flex; align-items:center; gap:10px; font-size:0.85rem;">
                    <i data-lucide="map-pin" color="#f97316"></i> <span id="gpsCoords">Mencari...</span>
                </div>
            </div>
            <div id="step-status" class="step-box">
                <div class="step-header">
                    <span>STATUS KEHADIRAN</span>
                    <i data-lucide="circle" class="step-icon" id="icon-status"></i>
                </div>
                <div class="status-grid">
                    <div class="status-box hadir" onclick="setStatus('Hadir', this, 'hadir')">
                        <i data-lucide="sun" size="20"></i> HADIR
                    </div>
                    <div class="status-box pulang" onclick="setStatus('Pulang', this, 'pulang')">
                        <i data-lucide="moon" size="20"></i> PULANG
                    </div>
                    <div class="status-box" onclick="setStatus('Izin', this, 'active')">
                        <i data-lucide="file-text" size="20"></i> IZIN
                    </div>
                    <div class="status-box" onclick="setStatus('Sakit', this, 'active')">
                        <i data-lucide="stethoscope" size="20"></i> SAKIT
                    </div>
                    <div class="status-box" onclick="setStatus('Dinas', this, 'active')">
                        <i data-lucide="briefcase" size="20"></i> DINAS
                    </div>
                    <div class="status-box" onclick="setStatus('Terlambat', this, 'active')">
                        <i data-lucide="clock" size="20"></i> TERLAMBAT
                    </div>
                </div>
                <div id="late-alert"></div>
            </div>
            <div id="step-note" class="step-box">
                <div class="step-header">
                    <span>CATATAN / URAIAN</span>
                    <i data-lucide="circle" class="step-icon" id="icon-note"></i>
                </div>
                <textarea id="performanceNote" oninput="validateForm()" rows="3" placeholder="Contoh: Monitoring Daerah Irigasi..."></textarea>
            </div>
            <div id="step-photo" class="step-box">
                <div class="step-header">
                    <span>DOKUMENTASI</span>
                    <i data-lucide="circle" class="step-icon" id="icon-photo"></i>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div class="camera-item" id="box-selfie" onclick="triggerCam('selfie')">
                        <i data-lucide="camera" id="icon-selfie" size="30"></i>
                        <span style="font-size:0.7rem; font-weight:800; margin-top:5px;">SELFIE</span>
                        <img id="prev-selfie">
                    </div>
                    <div class="camera-item" id="box-work" onclick="triggerCam('work')">
                        <i data-lucide="image" id="icon-work" size="30"></i>
                        <span style="font-size:0.7rem; font-weight:800; margin-top:5px;">KERJA</span>
                        <img id="prev-work">
                    </div>
                </div>
            </div>
            <button id="btnSubmit" onclick="submitAll()" disabled 
                style="width:100%; background:var(--accent-orange); color:white; border:none; padding:20px; border-radius:20px; font-weight:900; margin-top:30px; display:flex; align-items:center; justify-content:center; gap:10px; font-size: 1.1rem; box-shadow: 0 10px 25px rgba(249, 115, 22, 0.4); opacity: 0.5;">
                <i data-lucide="send"></i> KIRIM LAPORAN
            </button>
            <div class="app-footer">
                <img src="https://lh3.googleusercontent.com/d/1T2CMdDlMOVBTHr-hy1uBjZhxnKJPrd2m" alt="Logo Footer">
                <div>
                    <div style="font-weight: 800; font-size: 0.75rem; letter-spacing: 1px;">UPT PSDA WS BONDOYUDO</div>
                    <div style="font-size: 0.65rem;">Sistem Presensi Pegawai Digital v2.5</div>
                </div>
                <div class="social-icons">
                    <i data-lucide="globe"></i>
                    <i data-lucide="instagram"></i>
                    <i data-lucide="facebook"></i>
                </div>
            </div>

        </div>
    </div>

    <input type="file" id="camUser" accept="image/*" capture="user" style="display:none" onchange="handleCam(event)">
    <input type="file" id="camEnv" accept="image/*" capture="environment" style="display:none" onchange="handleCam(event)">
    <canvas id="wmCanvas" style="display:none"></canvas>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzLtpUUwkv6mXTzRzDZZJW8q4DDitoOaluh-9-BoesszvBwyGCdLYa_A3NXCJBevo2n/exec"; 
        let allPegawai = [], filtered = [], currentIndex = 0;
        let selectedStatus = '', curCam = '', gpsOk = false;
        let selectedRegion = 'ALL';
        let searchQuery = '';
        let sysConfig = {};
        let serverTimeOffset = 0;
        let isSubmitting = false;
        const ICONS = {
            clock: "M12 6v6l4 2 M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20z",
            mapPin: "M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z M12 13a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"
        };

        function loadData() {
            setInterval(updateClock, 1000); 
            fetch(SCRIPT_URL + '?action=getDashboardData')
                .then(response => response.json())
                .then(data => {
                    if(data.pegawai) {
                        allPegawai = data.pegawai.filter(p => p.Status === 'Aktif');
                        applyFilters();
                    }

                    if(data.tools) {
                        data.tools.forEach(c => sysConfig[c.Key] = c.Value);
                        document.getElementById('infoJamHadir').innerText = sysConfig.Jam_Hadir || '--:--';
                        document.getElementById('infoJamPulang').innerText = sysConfig.Jam_Pulang || '--:--';
                    }

                    if(data.serverTime) {
                        const srvTime = new Date(data.serverTime).getTime();
                        const clientTime = new Date().getTime();
                        serverTimeOffset = srvTime - clientTime;
                    }

                    document.getElementById('loadingOverlay').style.opacity = '0';
                    setTimeout(() => document.getElementById('loadingOverlay').style.display = 'none', 800);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    showToast('error', 'Gagal memuat data');
                });
        }

        function updateClock() {
            const now = new Date(new Date().getTime() + serverTimeOffset);
            document.getElementById('mainClock').innerText = now.toLocaleTimeString('id-ID', {hour12:false}).slice(0,5);
            document.getElementById('mainDate').innerText = now.toLocaleDateString('id-ID', {weekday:'short', day:'numeric', month:'short'});
        }

        function triggerCam(type) {
            curCam = type;
            if (type === 'selfie') document.getElementById('camUser').click(); 
            else document.getElementById('camEnv').click();
        }

        function drawIcon(ctx, pathData, x, y, size, color) {
            ctx.save();
            ctx.translate(x, y);
            ctx.scale(size/24, size/24); 
            ctx.lineWidth = 2.5; 
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = color;
            ctx.stroke(new Path2D(pathData));
            ctx.restore();
        }

        function handleCam(e) {
            const file = e.target.files[0];
            if (!file) return;

            showToast('loading', 'Memproses Foto...');

            const reader = new FileReader();
            reader.onload = function(ev) {
                const img = new Image();
                img.onload = function() {
                    const cvs = document.getElementById('wmCanvas');
                    const ctx = cvs.getContext('2d');

                    let targetW, targetH;
                    if (curCam === 'selfie') { targetW = 768; targetH = 1024; } 
                    else { targetW = 1024; targetH = 768; }

                    cvs.width = targetW; cvs.height = targetH;

                    let scale = Math.max(targetW / img.width, targetH / img.height);
                    let finalW = img.width * scale;
                    let finalH = img.height * scale;
                    let x = (targetW - finalW) / 2;
                    let y = (targetH - finalH) / 2;
                    ctx.drawImage(img, x, y, finalW, finalH);

                    // WATERMARK CONFIG
                    const wmHeight = 220;
                    const startY = targetH - wmHeight;
                    
                    const grad = ctx.createLinearGradient(0, startY, 0, targetH);
                    grad.addColorStop(0, "rgba(0, 0, 0, 0)"); 
                    grad.addColorStop(0.3, "rgba(0, 0, 0, 0.6)");
                    grad.addColorStop(1, "rgba(0, 0, 0, 0.95)"); 
                    ctx.fillStyle = grad;
                    ctx.fillRect(0, startY, targetW, wmHeight);

                    const padding = 40;
                    const contentY = targetH - 160;
                    ctx.fillStyle = "#f97316"; 
                    ctx.fillRect(padding, contentY - 20, 6, 140);

                    const textX = padding + 25;
                    ctx.fillStyle = "white";
                    ctx.shadowColor = "rgba(0,0,0,0.8)";
                    ctx.shadowBlur = 4;
                    
                    ctx.font = "bold 18px 'Plus Jakarta Sans', sans-serif";
                    ctx.fillStyle = "#cbd5e1"; 
                    ctx.fillText("UPT PSDA WS BONDOYUDO", textX, contentY - 45);

                    ctx.fillStyle = "white";
                    ctx.font = "800 36px 'Plus Jakarta Sans', sans-serif";
                    ctx.textBaseline = "top";
                    ctx.fillText(filtered[currentIndex].Nama.toUpperCase(), textX, contentY - 15);

                    const row2Y = contentY + 45;
                    drawIcon(ctx, ICONS.clock, textX, row2Y, 28, "#f97316"); 
                    const correctedDate = new Date(new Date().getTime() + serverTimeOffset);
                    const dateStr = correctedDate.toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
                    const timeStr = correctedDate.toLocaleTimeString('id-ID', {hour12:false});
                    ctx.font = "600 24px sans-serif";
                    ctx.fillStyle = "#e2e8f0";
                    ctx.fillText(`${timeStr} WIB  |  ${dateStr}`, textX + 40, row2Y + 2);

                    const row3Y = row2Y + 45;
                    drawIcon(ctx, ICONS.mapPin, textX, row3Y, 28, "#3b82f6"); 
                    const gpsText = document.getElementById('gpsCoords').innerText;
                    ctx.font = "500 22px monospace"; 
                    ctx.fillStyle = "#ffffff";
                    const statusText = selectedStatus.toUpperCase();
                    ctx.fillText(`${statusText}  â€¢  ${gpsText}`, textX + 40, row3Y + 2);

                    const url = cvs.toDataURL('image/jpeg', 0.85);
                    const prev = document.getElementById('prev-' + curCam);
                    prev.src = url; prev.style.display = 'block';
                    
                    document.getElementById('box-' + curCam).classList.add('has-photo');
                    document.getElementById('icon-' + curCam).style.display = 'none';

                    e.target.value = ''; 
                    hideToast();
                    validateForm();
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        }

        function applyFilters() {
            filtered = allPegawai.filter(p => {
                const matchSearch = p.Nama.toLowerCase().includes(searchQuery.toLowerCase());
                const matchRegion = selectedRegion === 'ALL' || p.Wilayah.toUpperCase() === selectedRegion.toUpperCase();
                return matchSearch && matchRegion;
            });
            currentIndex = 0; renderProfile();
        }

        function renderProfile() {
            const disp = document.getElementById('dispName');
            const photoDiv = document.getElementById('slidePhoto');
            if(!filtered.length) {
                disp.innerText = "Tidak Ditemukan";
                photoDiv.innerHTML = "";
                return;
            }
            const p = filtered[currentIndex];
            disp.innerText = p.Nama;
            document.getElementById('dispRole').innerText = p.Jabatan + " - " + p.Wilayah;
            photoDiv.innerHTML = `<img src="${p.Link_Foto_Profile || 'https://via.placeholder.com/400'}" alt="Profil">`;
        }

        function handleSearch() { searchQuery = document.getElementById('nameSearch').value.trim(); applyFilters(); }
        function setRegion(r, el) { selectedRegion = r; document.querySelectorAll('.chip').forEach(c => c.classList.remove('active')); el.classList.add('active'); applyFilters(); }
        function nextMember() { if(filtered.length) { currentIndex = (currentIndex + 1) % filtered.length; renderProfile(); } }
        function prevMember() { if(filtered.length) { currentIndex = (currentIndex - 1 + filtered.length) % filtered.length; renderProfile(); } }

        function openPresence() {
            if(!filtered.length) return;
            renderProfile(); 
            const p = filtered[currentIndex];
            document.getElementById('presName').innerText = p.Nama;
            document.getElementById('presRole').innerText = p.Jabatan;
            document.getElementById('presImg').src = p.Link_Foto_Profile || '';
            document.getElementById('presenceView').style.display = 'block';
            
            selectedStatus = '';
            document.getElementById('performanceNote').value = '';
            
            ['selfie', 'work'].forEach(t => {
                document.getElementById('prev-'+t).src = '';
                document.getElementById('prev-'+t).style.display = 'none';
                document.getElementById('box-'+t).classList.remove('has-photo');
                document.getElementById('icon-'+t).style.display = 'block';
            });

            updateStepIcon('icon-gps', false);
            updateStepIcon('icon-status', false);
            updateStepIcon('icon-note', false);
            updateStepIcon('icon-photo', false);
            document.getElementById('late-alert').style.display = 'none';

            document.querySelectorAll('.status-box').forEach(b => b.className = 'status-box');
            document.querySelectorAll('.step-box').forEach(s => s.classList.remove('active-step', 'is-valid'));
            document.getElementById('step-gps').classList.add('active-step');
            
            lucide.createIcons(); 
            getGPS();
        }

        function closePresence() { document.getElementById('presenceView').style.display = 'none'; }

        function getGPS() {
            document.getElementById('gpsCoords').innerText = "Melacak...";
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    document.getElementById('gpsCoords').innerText = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    gpsOk = true;
                    document.getElementById('step-gps').classList.add('is-valid');
                    updateStepIcon('icon-gps', true);
                    document.getElementById('step-status').classList.add('active-step');
                    validateForm();
                }, err => {
                    document.getElementById('gpsCoords').innerText = "GPS Error/Ditolak";
                    gpsOk = false;
                }, {enableHighAccuracy:true, timeout:10000});
            }
        }

        function setStatus(s, el, cls) {
            selectedStatus = s;
            document.querySelectorAll('.status-box').forEach(b => b.className = 'status-box');
            el.classList.add('active', cls);
            document.getElementById('step-status').classList.add('is-valid');
            updateStepIcon('icon-status', true);
            document.getElementById('step-note').classList.add('active-step');
            document.getElementById('step-photo').classList.add('active-step'); 
            
            const alertBox = document.getElementById('late-alert');
            alertBox.style.display = 'none'; 

            if(s === 'Hadir') {
                const now = new Date(new Date().getTime() + serverTimeOffset);
                const schedule = new Date(now);
                schedule.setHours(7, 30, 0, 0);

                if(now > schedule) {
                    const diffMs = now - schedule;
                    const diffMins = Math.floor(diffMs / 60000);
                    
                    alertBox.innerHTML = `<i data-lucide="alert-triangle" size="18"></i> TERLAMBAT ${diffMins} MENIT`;
                    alertBox.style.display = 'block';
                    
                    lucide.createIcons(); 
                }
            }

            validateForm();
        }

        function updateStepIcon(id, isValid) {
            const el = document.getElementById(id);
            if(isValid) {
                el.setAttribute('data-lucide', 'check-circle-2');
                el.style.color = '#10b981';
                el.style.opacity = '1';
            } else {
                el.setAttribute('data-lucide', 'circle');
                el.style.color = 'rgba(255,255,255,0.3)';
            }
            lucide.createIcons();
        }

        function validateForm() {
            const hasStatus = selectedStatus !== '';
            const hasNote = document.getElementById('performanceNote').value.trim().length > 3;
            const hasSelfie = document.getElementById('prev-selfie').src.startsWith('data:image');
            const hasWork = document.getElementById('prev-work').src.startsWith('data:image');

            updateStepIcon('icon-note', hasNote);
            updateStepIcon('icon-photo', hasSelfie && hasWork);

            const btn = document.getElementById('btnSubmit');
            if (gpsOk && hasStatus && hasNote && hasSelfie && hasWork) {
                btn.disabled = false;
                btn.style.opacity = '1';
            } else {
                btn.disabled = true;
                btn.style.opacity = '0.5';
            }
        }

        function submitAll() {
            if(isSubmitting) return;
            isSubmitting = true;

            showToast('loading', 'Mengirim Laporan...');
            
            const payload = {
                idPegawai: filtered[currentIndex].ID,
                nama: filtered[currentIndex].Nama,
                status: selectedStatus,
                keterangan: document.getElementById('performanceNote').value,
                gps: document.getElementById('gpsCoords').innerText,
                selfie: document.getElementById('prev-selfie').src,
                workPhoto: document.getElementById('prev-work').src
            };
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if(data.status === 'success') {
                    showToast('success', 'Laporan Berhasil!');
                    setTimeout(() => {
                        hideToast();
                        closePresence();
                        resetForm(); 
                        isSubmitting = false;
                    }, 2000);
                } else {
                    throw new Error(data.message || 'Unknown error');
                }
            })
            .catch(err => {
                showToast('error', 'Gagal: ' + err);
                isSubmitting = false; 
                setTimeout(hideToast, 3000);
            });
        }

        
        function resetForm() {
            selectedStatus = '';
            document.getElementById('performanceNote').value = '';
            
            ['selfie', 'work'].forEach(t => {
                document.getElementById('prev-'+t).src = '';
                document.getElementById('prev-'+t).style.display = 'none';
                document.getElementById('box-'+t).classList.remove('has-photo');
                document.getElementById('icon-'+t).style.display = 'block';
            });
            
            document.querySelectorAll('.status-box').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.step-box').forEach(s => s.classList.remove('active-step', 'is-valid'));
            document.getElementById('late-alert').style.display = 'none';
            
            
            updateStepIcon('icon-gps', false);
            updateStepIcon('icon-status', false);
            updateStepIcon('icon-note', false);
            updateStepIcon('icon-photo', false);
            
            
            document.getElementById('step-gps').classList.add('active-step');
            
            
            const btn = document.getElementById('btnSubmit');
            btn.disabled = true;
            btn.style.opacity = '0.5';
        }

        function showToast(type, msg) {
            const toast = document.getElementById('statusToast');
            const icon = document.getElementById('toastIcon');
            toast.style.display = 'flex';
            document.getElementById('toastMessage').innerText = msg.toUpperCase();
            if(type==='loading') icon.innerHTML = '<div class="spin"><i data-lucide="loader-2" size="48" color="white"></i></div>';
            else if(type==='success') icon.innerHTML = '<i data-lucide="check-circle" size="64" color="#10b981"></i>';
            else icon.innerHTML = '<i data-lucide="alert-circle" size="64" color="#ef4444"></i>';
            lucide.createIcons();
        }
        function hideToast() { document.getElementById('statusToast').style.display = 'none'; }

        window.onload = loadData;
        lucide.createIcons();
    </script>
</body>
</html>
